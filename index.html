<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TON Prediction – Production</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<meta name="theme-color" content="#1c1c1e">
<style>
:root{--bg:#1c1c1e;--card:#2c2c2e;--btn:#3390ec}
body{margin:0;font-family:system-ui;background:var(--bg);color:#fff}
.telegram-card{background:var(--card);border-radius:16px;border:1px solid rgba(255,255,255,.08)}
.telegram-button{background:var(--btn);border-radius:12px}
.up{background:linear-gradient(180deg,#31D0AA,#2BC48A)}
.down{background:linear-gradient(180deg,#ED4B9E,#E93C8F)}
.floating{position:fixed;bottom:0;left:0;right:0;background:var(--card);padding:12px}
.text-up{color:#31D0AA}.text-down{color:#ED4B9E}.muted{color:#8E8E93}
</style>
</head>
<body>
<div id="root"></div>

<script>
const {useState,useEffect,useRef,useMemo,useCallback}=React;

/**************** CONFIG ****************/
const CONFIG={
 MIN_BET:1,
 MAX_BET:1000,
 ROUND_DURATION:60,
 COMMISSION:0.03,
 PRICE_INTERVAL:5000
};

/**************** TRANSLATIONS ****************/
const T={
 en:{title:"TON Prediction",balance:"Balance",add:"Add 100 TON",placed:"Bet placed",insufficient:"Insufficient balance",range:(a,b)=>`Enter amount from ${a} to ${b} TON`},
 ru:{title:"Предсказания TON",balance:"Баланс",add:"Пополнить 100 TON",placed:"Ставка размещена",insufficient:"Недостаточно средств",range:(a,b)=>`Введите сумму от ${a} до ${b} TON`}
};

/**************** SAFE STORAGE ****************/
const load=(k,d)=>{try{const v=localStorage.getItem(k);return v?JSON.parse(v):d}catch{return d}};
const save=(k,v)=>{try{localStorage.setItem(k,JSON.stringify(v))}catch{}};

/**************** AUDIO ****************/
function useSound(){
 const ref=useRef(null);
 return ()=>{
  if(!ref.current) ref.current=new (window.AudioContext||window.webkitAudioContext)();
  const ctx=ref.current;if(ctx.state==='suspended')ctx.resume();
  const o=ctx.createOscillator(),g=ctx.createGain();o.frequency.value=800;g.gain.value=.1;o.connect(g);g.connect(ctx.destination);o.start();o.stop(ctx.currentTime+.1);
  if(window.Telegram?.WebApp?.HapticFeedback) Telegram.WebApp.HapticFeedback.impactOccurred('light');
 };
}

/**************** PRICE HOOK ****************/
function usePrices(){
 const [price,setPrice]=useState(0);
 const fetchPrice=useCallback(async()=>{
  try{
   const r=await fetch('https://api.coingecko.com/api/v3/simple/price?ids=the-open-network&vs_currencies=usd');
   const j=await r.json();
   setPrice(j['the-open-network'].usd);
  }catch{}
 },[]);
 useEffect(()=>{fetchPrice();const i=setInterval(fetchPrice,CONFIG.PRICE_INTERVAL);return()=>clearInterval(i)},[fetchPrice]);
 return price;
}

/**************** ROUND ENGINE ****************/
function newRound(id,status,price){
 const now=Date.now();
 return{ id,status,start:now,end:now+CONFIG.ROUND_DURATION*1000,locked:price,close:null,poolUp:0,poolDown:0 };
}

/**************** APP ****************/
function App(){
 const [lang,setLang]=useState(load('lang','en'));
 const t=T[lang];
 const [balance,setBalance]=useState(load('balance',50));
 const [bets,setBets]=useState(load('bets',[]));
 const price=usePrices();
 const sound=useSound();

 const [rounds,setRounds]=useState(()=>{
  const p=price||6;
  return [newRound(1,'prev',p),newRound(2,'live',p),newRound(3,'next',p)];
 });

 useEffect(()=>save('balance',balance),[balance]);
 useEffect(()=>save('bets',bets),[bets]);
 useEffect(()=>save('lang',lang),[lang]);

 // round lifecycle
 useEffect(()=>{
  const i=setInterval(()=>{
   setRounds(rs=>{
    const live=rs.find(r=>r.status==='live');
    if(!live||Date.now()<live.end) return rs;

    const closePrice=price||live.locked;
    const isUp=closePrice>=live.locked;

    // settle bets
    setBets(bs=>bs.map(b=>{
     if(b.roundId!==live.id) return b;
     const win=(b.side==='up'&&isUp)||(b.side==='down'&&!isUp);
     if(win){
      const pool=isUp?live.poolUp:live.poolDown;
      const total=live.poolUp+live.poolDown;
      const payout=b.amount*(total/pool)*(1-CONFIG.COMMISSION);
      setBalance(x=>x+payout);
     }
     return {...b,final:true,win};
    }));

    const prev={...live,status:'prev',close:closePrice};
    const next=rs.find(r=>r.status==='next');
    const newLive={...next,status:'live',start:Date.now(),end:Date.now()+CONFIG.ROUND_DURATION*1000,locked:price||next.locked};
    const newNext=newRound(next.id+1,'next',price||next.locked);

    return rs.filter(r=>r.status==='prev').slice(-2).concat([prev,newLive,newNext]);
   });
  },1000);
  return()=>clearInterval(i);
 },[price]);

 const placeBet=(r,side)=>{
  const amount=10;
  if(amount<CONFIG.MIN_BET||amount>CONFIG.MAX_BET){alert(t.range(CONFIG.MIN_BET,CONFIG.MAX_BET));return}
  if(amount>balance){alert(t.insufficient);return}
  sound();
  setBalance(b=>b-amount);
  setBets(b=>[...b,{roundId:r.id,side,amount,final:false}]);
  setRounds(rs=>rs.map(x=>{
   if(x.id===r.id){side==='up'?x.poolUp+=amount:x.poolDown+=amount}
   return {...x};
  }));
  alert(t.placed);
 };

 return React.createElement('div',{className:'min-h-screen pb-24'},

  React.createElement('header',{className:'p-4 flex justify-between'},
   React.createElement('h1',null,t.title),
   React.createElement('div',null,
    React.createElement('div',null,`${balance.toFixed(2)} TON`),
    React.createElement('div',{className:'muted text-xs'},t.balance)
   )
  ),

  React.createElement('div',{className:'p-4 muted'},`TON price: $${price.toFixed(3)}`),

  React.createElement('main',{className:'p-4 flex gap-4 overflow-x-auto'},
   rounds.map(r=>React.createElement('div',{key:r.id,className:'telegram-card p-4 w-64'},
    React.createElement('div',{className:'font-bold mb-1'},`#${r.id} ${r.status}`),
    React.createElement('div',{className:'text-xs muted mb-2'},`Locked: $${r.locked?.toFixed(3)}`),

    r.status==='live'&&React.createElement('div',{className:'mb-2'},`Current: $${price.toFixed(3)}`),

    r.status==='next'&&React.createElement('div',{className:'flex gap-2 mb-2'},
     React.createElement('button',{className:'up flex-1 py-2 rounded',onClick:()=>placeBet(r,'up')},'UP'),
     React.createElement('button',{className:'down flex-1 py-2 rounded',onClick:()=>placeBet(r,'down')},'DOWN')
    ),

    React.createElement('div',{className:'text-xs'},`Pool UP: ${r.poolUp.toFixed(2)} / DOWN: ${r.poolDown.toFixed(2)}`),
    r.status==='prev'&&React.createElement('div',{className:r.close>=r.locked?'text-up':'text-down'},`Closed: $${r.close?.toFixed(3)}`)
   ))
  ),

  React.createElement('div',{className:'floating'},
   React.createElement('button',{className:'telegram-button w-full py-3',onClick:()=>setBalance(b=>b+100)},t.add)
  )
 );
}

const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(React.createElement(App));
</script>
</body>
</html>